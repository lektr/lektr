# =============================================================================
# Combined Container Docker Compose
# =============================================================================
# Single container with API + UI + Nginx, plus separate DB container
# Access: http://localhost or http://YOUR_IP
# =============================================================================

services:
  # ─────────────────────────────────────────────────────────────────────────────
  # Database (PostgreSQL with pgvector)
  # ─────────────────────────────────────────────────────────────────────────────
  db:
    image: pgvector/pgvector:pg16
    container_name: lektr_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-lektr}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lektr_dev}
      POSTGRES_DB: ${POSTGRES_DB:-lektr}
    # for production security access to ports is closed
    # ports:
    #   - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lektr"]
      interval: 5s
      timeout: 3s
      retries: 10

  # ─────────────────────────────────────────────────────────────────────────────
  # Combined App Container (API + UI + Nginx)
  # ─────────────────────────────────────────────────────────────────────────────
  app:
    image: lektr/lektr:latest
    container_name: lektr_app
    restart: unless-stopped
    environment:
      # Database connection
      POSTGRES_USER: ${POSTGRES_USER:-lektr}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-lektr_dev}
      POSTGRES_DB: ${POSTGRES_DB:-lektr}
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      # Frontend - empty = relative paths (Nginx handles routing)
      NEXT_PUBLIC_API_URL: ""
      # CORS - include your LAN IP for external access, comma separated, for example:
      # CORS_ORIGINS: "http://localhost,http://192.168.68.59"
      CORS_ORIGINS: "http://localhost"
      # Security - JWT_SECRET MUST be set in production!
      JWT_SECRET: ${JWT_SECRET:-}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-admin@lektr.local}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-admin123}
      # Optional API keys
      HARDCOVER_API_KEY: ${HARDCOVER_API_KEY:-}
    ports:
      - "${LEKTR_PORT:-80}:80"
    depends_on:
      db:
        condition: service_healthy
    # Persist downloaded covers
    volumes:
      - api_covers:/app/lektr-api/data/covers
    # Resource limits to prevent system freeze
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '3.0'
        reservations:
          memory: 1G

volumes:
  pgdata:
    name: lektr_pgdata
  api_covers:
    name: lektr_api_covers
